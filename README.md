# é˜¿é‡Œäº‘æœåŠ¡å™¨ä¸Šæ­å»ºWebRTCæ•™ç¨‹
ç½‘é¡µå³æ—¶é€šä¿¡ï¼ˆWeb Real-Time Communicationï¼‰ï¼Œæ˜¯ä¸€ä¸ªæ”¯æŒç½‘é¡µæµè§ˆå™¨è¿›è¡Œå®æ—¶è¯­éŸ³å¯¹è¯æˆ–è§†é¢‘å¯¹è¯çš„APIï¼Œä¸€å…±éœ€è¦æ­å»ºä¸‰ä¸ªæœåŠ¡å™¨

æˆ¿é—´æœåŠ¡å™¨ï¼Œä¿¡ä»¤æœåŠ¡å™¨ï¼Œå†…ç½‘ç©¿é€æœåŠ¡å™¨
	
ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€ğŸ€

###æˆ¿é—´æœåŠ¡å™¨(appRTC):

å¼€æºå®ç°: [github.com/webrtc/apprtc](url)

æˆ¿é—´æœåŠ¡å™¨æ˜¯ç”¨æ¥åˆ›å»ºå’Œç®¡ç†é€šè¯ä¼šè¯çš„çŠ¶æ€ç»´æŠ¤,æ˜¯é€šè¯è¿˜æ˜¯å¤šæ–¹é€šè¯,åŠ å…¥ä¸ç¦»å¼€æˆ¿é—´ç­‰ç­‰

###ä¿¡ä»¤æœåŠ¡å™¨(collider):

ä¿¡ä»¤å°±æ˜¯ä¸ºäº†å»ºç«‹ä¸€ä¸ªwebRTCçš„é€šè®¯è¿‡ç¨‹ï¼Œå®¢æˆ·ç«¯éœ€è¦äº¤æ¢å¦‚ä¸‹ä¿¡æ¯

1. ä¼šè¯æ§åˆ¶ä¿¡æ¯ï¼Œç”¨æ¥å¼€å§‹å’Œç»“æŸé€šè¯ï¼Œå³å¼€å§‹è§†é¢‘ã€ç»“æŸè§†é¢‘è¿™äº›æ“ä½œæŒ‡ä»¤ã€‚
2. å‘ç”Ÿé”™è¯¯æ—¶ç”¨æ¥ç›¸äº’é€šå‘Šçš„æ¶ˆæ¯
3. å…ƒæ•°æ®ï¼Œå¦‚å„è‡ªçš„éŸ³è§†é¢‘è§£ç æ–¹å¼ã€å¸¦å®½ã€‚
4. ç½‘ç»œæ•°æ®ï¼Œå¯¹æ–¹çš„å…¬ç½‘IPã€ç«¯å£ã€å†…ç½‘IPåŠç«¯å£ã€‚

###å†…ç½‘ç©¿é€æœåŠ¡å™¨

å¼€æºå®ç°: [github.com/coturn/coturn](url)

å†…ç½‘ç©¿é€å³NATç©¿é€ï¼Œç½‘ç»œè¿æ¥æ—¶æœ¯è¯­ï¼Œè®¡ç®—æœºæ˜¯å±€åŸŸç½‘å†…æ—¶ï¼Œå¤–ç½‘ä¸å†…ç½‘çš„è®¡ç®—æœºèŠ‚ç‚¹éœ€è¦è¿æ¥é€šä¿¡ï¼Œæœ‰æ—¶å°±ä¼šå‡ºç°ä¸æ”¯æŒå†…ç½‘ç©¿é€ã€‚
å°±æ˜¯è¯´æ˜ å°„ç«¯å£,èƒ½è®©å¤–ç½‘çš„ç”µè„‘æ‰¾åˆ°å¤„äºå†…ç½‘çš„ç”µè„‘,æé«˜ä¸‹è½½é€Ÿåº¦ã€‚
ä¸ç®¡æ˜¯å†…ç½‘ç©¿é€è¿˜æ˜¯å…¶ä»–ç±»å‹çš„ç½‘ç»œç©¿é€ï¼Œéƒ½æ˜¯ç½‘ç»œç©¿é€çš„ç»Ÿä¸€æ–¹æ³•æ¥ç ”ç©¶å’Œè§£å†³ã€‚
NATç©¿é€ï¼Œnatç©¿é€ä¸­æœ‰å…³äºç½‘ç»œç©¿é€çš„è¯¦ç»†ä¿¡æ¯ã€‚WebRTC å¯ä»¥ä½¿ç”¨ICEæ¡†æ¶å»å…‹æœçœŸå®ä¸–ç•Œçš„å¤æ‚ç½‘ç»œã€‚

STUN (Simple Traversal of UDP Through NAT)ï¼Œæ˜¯ä¸€ä¸ªå®Œæ•´çš„NATç©¿é€è§£å†³æ–¹æ¡ˆï¼Œå³ç®€å•çš„ç”¨UDPç©¿é€NATã€‚
â€‹	

TURN (Traversal Using Relay NAT), ä¸STUNä¸€æ ·ä¸ºäº†å®Œæˆç©¿é€æ•ˆæœï¼Œä½†æ˜¯TURNæ˜¯é€šè¿‡è½¬å‘çš„æ–¹å¼æ¥å®ç°ç©¿é€ã€‚
â€‹	

ICE (Interactive Connectivity Establishment), ç»¼åˆä»¥ä¸Š2ç§åè®®çš„ç»¼åˆæ€§NATç©¿è¶Šè§£å†³æ–¹æ¡ˆã€‚é¦–å…ˆä¼šå°è¯•ç”¨è®¾å¤‡ç³»ç»Ÿæˆ–ç½‘å¡è·å–åˆ°çš„ä¸»æœºåœ°å€å»å»ºç«‹è¿æ¥ï¼›å¦‚æœè¿™ä¸ªå¤±è´¥äº†ï¼ˆè®¾å¤‡åœ¨NATsåé¢å°±ä¼šï¼‰ICEä»STUNæœåŠ¡å™¨è·å¾—å¤–éƒ¨çš„åœ°å€ï¼Œå¦‚æœè¿™ä¸ªä¹Ÿå¤±è´¥äº†ï¼Œå°±ç”¨TURNä¸­è½¬æœåŠ¡å™¨åšé€šè®¯ã€‚

**WARNING**

è¯·å¼€æ”¾ä½ çš„é˜²ç«å¢™ç«¯å£8080ã€8089ã€3478ã€80ã€443


ä¸‹é¢çš„å®‰è£…è¿‡ç¨‹éœ€è¦**git**ã€**wget**è¯·è‡ªè¡Œå®‰è£…

### å®‰è£…Gitä¾èµ–ğŸŒ‹
	sudo yum install -y make auomake gcc cc gcc-c++ wget
	sudo yum -y install zlib-devel openssl-devel cpio expat-devel gettext-devel curl-devel perl-ExtUtils-CBuilder perl-ExtUtils-MakeMaker
    wget git.tar.gz
    tar -zxvf git.tar.gz
    cd git.tar.gz
    sudo make prefix=/usr/local all
    sudo make prefix=/usr/local install
    sudo yum install git

### ä¸€ã€APPRTCå®‰è£…ğŸš©

å®‰è£…ä¾èµ–ç¨‹åºæ ¹æ®è‡ªèº«æƒ…å†µ,è€ƒè™‘æ˜¯å¦é€‚ç”¨sudo

    sudo yum install ant

    sudo yum install -y nodejs

    sudo yum install npm

    sudo npm -g install grunt-cli

æˆ‘ä¸€èˆ¬å°†ä¸‹è½½çš„é¡¹ç›®æ”¾åœ¨/usr/local/soft/ä¸‹

    1. git clone https://github.com/webrtc/apprtc
    2. cd apprtc
    3. ä¸‹è½½Google App Engine SDKåˆ°apprtcç›®å½•
    4. è®¾ç½®Google App Engine SDKçš„ç¯å¢ƒå˜é‡ï¼šexport PATH=$PATH:/usr/local/soft/apprtc/google_appengine
    5. sudo npm install
    6. sudo grunt build
    7. dev_appserver.py --host ip ./out/app_engine/

### äºŒã€COLLIDERå®‰è£…

    1. mkdir collider
    2. cp -r apprtc/src/collider collider/src(apprtcé¡¹ç›®é‡Œæœ‰collider,å°†å®ƒæ‹·è´åˆ°æ ¹ç›®å½•ä¸‹çš„collider/src)
    3. export COLLIDER_ROOT=$HOME/collider

ç”±äºcolliderä¿¡ä»¤æœåŠ¡å™¨æ˜¯ç”¨goè¯­è¨€å†™çš„,æ‰€ä»¥æˆ‘ä»¬éœ€è¦æ­å»ºgoç¯å¢ƒ

    goè¯­è¨€å®‰è£…

    4.wget https://dl.google.com/go/go1.11.4.linux-amd64.tar.gz

    5.tar -C /usr/local -xzf go1.4.linux-amd64.tar.gz

    6. è¿›å…¥åˆ°æ­¥éª¤1åˆ›å»ºçš„collider/srcç›®å½• go get collidermain

    7. go install collidermain

æ³¨æ„ï¼šå®‰è£…å‡ºç°çš„é”™è¯¯ï¼ˆgo getæŠ¥é”™unrecognized import path â€œgolang.org/x/net/contextâ€ï¼‰
	
	$mkdir -p $GOPATH/src/golang.org/x/
	$cd $GOPATH/src/golang.org/x/
	$git clone https://github.com/golang/net.git net 
	$go install net
	
    ä¸å‡ºæ„å¤–çš„è¯ä¼šåœ¨colliderç›®å½•ä¸‹ç”Ÿæˆoutç›®å½•,é‡Œé¢æœ‰collidermainè¿è¡Œå‘½ä»¤

### ä¸‰ã€COTURNå®‰è£…

    1.wget http://turnserver.open-sys.org/downloads/v4.5.0.5/turnserver-4.5.0.5-CentOS7.2-x86_64.tar.gz

    2.å®‰è£…turnserverä¾èµ– libevent
    
     wget http://coturn.net/turnserver/v4.5.0.7/turnserver-4.5.0.7.tar.gz
     tar xvf libevent-2.0.21-stable.tar.gz
     cd libevent-2.0.21-stable
     ./configure
     make install
   
    3.å®‰è£…turnserver
    ./configure make make install

é…ç½® turnserver.conf

	cd /usr/local/etc
	sudo cp turnserver.conf.default turnserver.conf
	sudo vim turnserver.conf


é…ç½®å¦‚ä¸‹ä¿¡æ¯
	
 	listening-device=eth0
	listening-port=3478
	tls-listening-port=5349
	min-port=59000
	max-port=65000
	Verbose
	fingerprint
	lt-cred-mech
	use-auth-secret
	static-auth-secret=hechao
	realm=<hechao>
	user=hechao:0x4a5bb70f7a87322fec2920bd24679891
	user=hechao:123456
	stale-nonce
	cert=/etc/turn_server_cert.pem
	pkey=/etc/turn_server_pkey.pem
	no-loopback-peers
	no-multicast-peers
	mobility
	no-cli

ç”Ÿæˆmd5ç ï¼šturnadmin -k â€“u ç”¨æˆ·å -r å¯†é’¥ -p å¯†ç 

    ä¿®æ”¹static-auth-secret=yourname realm=<yourname>
    user=name:0xe89026fdb3ecba762464df471f383559
    user=name:password

ç”¨Opensslå‘½ä»¤ç”Ÿæˆä¸Šé¢certå’Œpkeyé…ç½®çš„è‡ªç­¾åè¯ä¹¦ï¼š

    sudo openssl req -x509 -newkey rsa:2048 -keyout   /etc/turn_server_pkey.pem -out /etc/turn_server_cert.pem -days 99999 -nodes

å¯åŠ¨æ‰“æ´ç©¿é€æœåŠ¡ï¼šturnserver -v /usr/local/etc/turnserver.conf

### å››ã€é…ç½®ä¿¡ä»¤å’Œæˆ¿é—´æœåŠ¡å™¨ğŸ‰ğŸ±â€ğŸ

    è¿›å…¥åˆ°æ­¥éª¤äºŒã€åˆ›å»ºçš„colliderç›®å½•ä¸‹
    cd collider/src/collider/collidermain
    sudo vim main.go

    è®¾ç½®æœåŠ¡å™¨åœ°å€å’Œipï¼ˆå°†127.0.0.1æ›¿æ¢ä¸ºä½ çš„æœåŠ¡å™¨ipï¼‰ï¼š

    var roomSrv = flag.String("room-server", "https://å¤–ç½‘ip:8080", "The origin of the room server")

    åˆ‡æ¢åˆ°apprtcç›®å½•ï¼Œä¿®æ”¹æˆ¿é—´æœåŠ¡å™¨ç›¸å…³é…ç½®


ç¼–è¾‘constants.py

    ICE_SERVER_OVERRIDE  = [  
    {
   	
    'urls': [ 
    	"turn:å†…å¤–ip:3478?transport=udp",
       	"turn:å†…å¤–ip:3478?transport=tcp"
     ],
     "username": "turnadminç”Ÿæˆçš„name",
     "credential": "turnadminç”Ÿæˆçš„å¯†é’¥"
    },
    {
     "urls": [
       "stun:å†…ç½‘:3478"
     ]
    }
    ]

    ICE_SERVER_BASE_URL = 'https://alexshopping.top'
    ICE_SERVER_URL_TEMPLATE = '%s/v1alpha/iceconfig?key=%s'
    ICE_SERVER_API_KEY = os.environ.get('ICE_SERVER_API_KEY')

    WSS_INSTANCE_HOST_KEY = 'å¤–ç½‘ip:8089'
    WSS_INSTANCE_NAME_KEY = 'vm_name'
    WSS_INSTANCE_ZONE_KEY = 'zone'
    WSS_INSTANCES = [{
        WSS_INSTANCE_HOST_KEY: 'å¤–ç½‘ip:8089',
        WSS_INSTANCE_NAME_KEY: 'wsserver-std',
        WSS_INSTANCE_ZONE_KEY: 'us-central1-a'
    },{
        WSS_INSTANCE_HOST_KEY: 'å¤–ç½‘ip:8089',
        WSS_INSTANCE_NAME_KEY: 'wsserver-std-2',
        WSS_INSTANCE_ZONE_KEY: 'us-central1-f'
    }]

ç¼–è¾‘apprtc.py

**å¦‚æœä½ åªæ˜¯æœ¬åœ°æµ‹è¯•ç”¨çš„è¯ä½¿ç”¨è¿™ä»½**

    def get_wss_parameters(request):
      ws_host_port_pair = request.get('wshpp')
      ws_tls = request.get('wstls')
    
      if not ws_host_port_pair:
        memcache_client = memcache.Client()
        ws_active_host = memcache_client.get(constants.WSS_HOST_ACTIVE_HOST_KEY)
        if ws_active_host in constants.WSS_HOST_PORT_PAIRS:
          ws_host_port_pair = ws_active_host
        else:
          logging.warning(
              'Invalid or no value returned from memcache, using fallback: '
              + json.dumps(ws_active_host))
          ws_host_port_pair = constants.WSS_HOST_PORT_PAIRS[0]
    
      if wss_tls and wss_tls == 'false':
        wss_url = 'ws://' + ws_host_port_pair + '/ws'
        wss_post_url = 'http://' + ws_host_port_pair
      else:
        wss_url = 'ws://' + ws_host_port_pair + '/ws'
        wss_post_url = 'http://' + ws_host_port_pair
      return (wss_url, wss_post_url)

**å¦‚æœä½ æœ‰SSLè¯ä¹¦ä½¿ç”¨è¿™ä»½**

    def get_wss_parameters(request):
      wss_host_port_pair = request.get('wshpp')
      wss_tls = request.get('wstls')
    
      if not wss_host_port_pair:
        # Attempt to get a wss server from the status provided by prober,
        # if that fails, use fallback value.
        #   wss_host_port_pair = constants.WSS_HOST_PORT_PAIR
        memcache_client = memcache.Client()
        wss_active_host = memcache_client.get(constants.WSS_HOST_ACTIVE_HOST_KEY)
        if wss_active_host in constants.WSS_HOST_PORT_PAIRS:
          wss_host_port_pair = wss_active_host
        else:
          logging.warning(
              'Invalid or no value returned from memcache, using fallback: '
              + json.dumps(wss_active_host))
          wss_host_port_pair = constants.WSS_HOST_PORT_PAIRS[0]
    
      if wss_tls and wss_tls == 'false':
        wss_url = 'ws://' + wss_host_port_pair + '/ws'
        wss_post_url = 'http://' + wss_host_port_pair
      else:
        wss_url = 'wss://' + wss_host_port_pair + '/ws'
        wss_post_url = 'https://' + wss_host_port_pair
      return (wss_url, wss_post_url)

å¯åŠ¨apprtcæœåŠ¡å™¨

    dev_appserver.py --enable_host_checking=false --host å†…ç½‘ip(172.x.x.186) /usr/local/soft/apprtc/out/app_engine
    
    æˆ–è€…åå°è¿è¡Œ
    
    nohup dev_appserver.py --enable_host_checking=false --host å†…ç½‘ip(172.x.x.186) /usr/local/soft/apprtc/out/app_engine/ &
    

æ‰€ä»¥éƒ½é…ç½®å¥½åå¯åŠ¨æœåŠ¡å™¨

    dev_appserver.py --enable_host_checking=false --host å†…ç½‘ip(172.x.x.186) /usr/local/soft/apprtc/out/app_engine

    cd /collider/bin/
    ./collidermain -port=8089 -tls=true
    
    cd /usr/local/soft/turnserver-4.5.0.7/bin
    ./turnserver -v /usr/local/etc/turnserver.conf
    
é…ç½®nginx

åå‘ä»£ç†apprtcï¼Œä½¿ä¹‹æ”¯æŒhttpsè®¿é—®ï¼Œå¦‚æœhttpç›´æ¥è®¿é—®apprtcï¼Œåˆ™å®¢æˆ·ç«¯æ— æ³•å¯åŠ¨è§†é¢‘éŸ³é¢‘é‡‡é›†ï¼ˆå¿…é¡»å¾—ç”¨httpsè®¿é—®ï¼‰

    yum -y install nginx
    vim /etc/nginx/nginx.conf
    
    user nginx;
    worker_processes auto;
    error_log /var/log/nginx/error.log;
    pid /run/nginx.pid;
    
    include /usr/share/nginx/modules/*.conf;
    
    events {
        worker_connections 1024;
    }
    
    http {
        log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '
                          '$status $body_bytes_sent "$http_referer" '
                          '"$http_user_agent" "$http_x_forwarded_for"';
    
        access_log  /var/log/nginx/access.log  main;
    
        sendfile            on;
        tcp_nopush          on;
        tcp_nodelay         on;
        keepalive_timeout   65;
        types_hash_max_size 2048;
    
        include             /etc/nginx/mime.types;
        default_type        application/octet-stream;
        
        upstream roomserver{
             server 47.x.x.61:8080;
             }
             server {
                 listen       80;
                 server_name  åŸŸå;
                 if ($scheme = http) {
                   return 301 https://$server_name$request_uri;
                }
                # location / {
                # }
        
                # error_page 404 /404.html;
                #     location = /40x.html {
                # }
        
                # error_page 500 502 503 504 /50x.html;
                #     location = /50x.html {
                # }
             }
             
        server {
                #listen       80;
                #listen       443 ssl http2 default_server;
                #listen       [::]:443 ssl http2 default_server;
                listen       443 ssl;
                root         /usr/share/nginx/html;
        
                ssl_certificate "/developer/key/alexshopping.top.pem";
                ssl_certificate_key "/developer/key/alexshopping.top.key";
                ssl_session_cache shared:SSL:1m;
                ssl_session_timeout  10m;
                ssl_ciphers HIGH:!aNULL:!MD5;
                ssl_prefer_server_ciphers on;
        
                location / {
                  proxy_pass http://roomserver$request_uri;
                  proxy_http_version 1.1;
                  proxy_set_header Upgrade $http_upgrade;
                  proxy_set_header Connection "upgrade";
                  proxy_set_header Host $host;
                }
            error_page 404 /404.html;
                        location = /40x.html {
                    }
            
                    error_page 500 502 503 504 /50x.html;
                        location = /50x.html {
                    }
                }
            }
            
é‡å¯nginx
            
     nginx -t
     nginx -s reload

å¦‚æœä½ ä½¿ç”¨äº†éæ ‡å‡†ç«¯å£ï¼Œæˆ–è€…ä½¿ç”¨è·¯ç”±å™¨ä¸Šçš„ç«¯å£æ˜ å°„ä¸ºå¹¿åŸŸç½‘æä¾›æµ‹è¯•å’ŒæœåŠ¡ï¼Œè¿˜éœ€è¦ä¿®æ”¹WEBå‰ç«¯çš„ä¸€äº›ä»£ç ã€‚
å¦åˆ™ä¼šé‡åˆ°æµè§ˆå™¨çš„è·¨åŸŸè®¿é—®é—®é¢˜ï¼ˆä¸»è¦æ˜¯ pushState ä¼šäº§ç”Ÿä¸€ä¸ªé”™è¯¯ï¼‰ï¼Œè¿™ä¹ˆæ”¹


    cd /usr/local/soft/apprtc/src/web_app/js/appcontroller.js
        
    è¿™ä¸ªæ–‡ä»¶é‡Œæœ‰è¿™æ ·çš„ä¸¤ä¸ªå‡½æ•°ï¼š
    AppController.prototype.pushCallNavigation_
    AppController.prototype.displaySharingInfo_
        
    åˆ†åˆ«åœ¨è¿™ä¸¤è¡Œå‡½æ•°å†…éƒ¨çš„å¼€å¤´ï¼ŒåŠ ä¸Šå¦‚ä¸‹ä»£ç ï¼š
    roomLink = roomLink.replace(/apprtc\.domain\.com\//, 'apprtc.domain.com:8083/');
        
    ä¿å­˜é€€å‡º


![](img/apprtc.png)
